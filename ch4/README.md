# 基于优化的规划算法

本章介绍基于优化的轨迹规划算法。

## 优化问题的一般形式

数学中的优化问题可以表示成以下较为通用的形式：

$$
\min f(x) \\
\text{s.t.} \\
g(x) < 0, h(x) = 0
$$

这里$f(x)$为一个$\mathbb{R}^n \rightarrow \mathbb{R}$的函数，在优化问题中常被称为代价函数(Cost function)，而在强化学习等其他领域有时也将其相反数称为奖励函数(Reward)。其定义域可以有多于一个维度，视实际问题而定，而其值域为实数或其他偏序空间，从而可以决定不同输入的优劣。

$g(x)<0$和$h(x)=0$被称为约束条件(constraints)，分为不等式约束和等式约束。它们用来限制输入的范围。

许多实际问题中变量都不可能取到任意值，商业问题可能会有库存总量限制，机器人运动规划可能会有马达扭矩限制等，这些都可以以不等式约束的方式来表达；而机器人动力学方程、调度问题物品总量守恒等都可以用等式约束的形式表达。

## 移动机器人优化问题特点

机器人运动规划问题相比于更一般的规划问题有以下两个特点：

1. 机器人运动规划一般采用离散的形式，将轨迹表示成一个个状态点，并用马尔可夫过程来建模，即下一状态只与当前状态下的行动有关而与更早的状态无关，从而我们其实可以得到一组等式约束：
$$
s_t = d(s_{t-1}, a_{t-1}), \forall i \in [1, t] 
$$
其中d为运动学方程。
从而在设计代价函数的过程中，也可以对轨迹上各个状态独立设计：
$$
c_t = c(s_{t}, a_{t})
$$
2. 机器人运动规划中常用的优化算法一般希望代价函数的一阶导数是连续的。

## 代价函数

下面来介绍几种机器人运动规划中常用到的几种代价函数。代价函数的设计要考虑希望解决的优化问题的特点，以及使用的优化算法，以下部分针对移动机器人运动规划，便是考虑了前述两个特点。

### 动力学相关的代价函数

移动机器人轨迹规划中，常对动力学参数有一定的要求，例如最大加速度的限制、刹车的加速度的限制，或我们希望以绝对值尽量小的控制量来完成运动操作（从而使轨迹尽量光滑）。

针对有边界限制的量，除了把他们设置成优化问题本身的不等式约束之外，我们也可以考虑惩罚超出边界的情况，以huber loss为例：

$$
c(x) = 
\begin{cases}
-\delta (x - l + \frac{1}{2}\delta), & x \le l-\delta \\
\frac{1}{2}(x-l)^2, & l-\delta < x \le l \\
0, & l < x \le u \\
\frac{1}{2}(x-u)^2, & u < x \le u + \delta \\
\delta (x - u - \frac{1}{2}\delta), & x > u + \delta \\
\end{cases}
$$

其函数图像大致如下所示（$l=-2.0, u=2.0, \delta=0.5$）:

<img src="resources/huber.png" width="400"/>

而针对希望绝对值尽量小的量（例如加速度，曲率等），可以简单地使用平方作为代价函数：

$$
c(x) = x^2
$$

这个图象就暂且不画了。

### lane-keeping / path tracking

移动机器人优化问题中一个常见的任务是要沿着某条轨迹，比如扫地机器人按照规划好的路线，或者自动驾驶汽车沿着车道线。这里介绍两种不同的情况：

第一种情况，我们对于机器人在每个时间点运动到的位置有要求，即假定我们已经有了一个轨迹$(x_t, y_t)$。这种情况下我们可以用一个比较简单的距离函数作为代价函数：

$$
c_t(s) = [ (x - x_t)^2 + (y - y_t)^2 ] 
$$

要注意这里的下标，即对每一时刻，这个函数取到最小值的点都是我们希望跟随的轨迹对应时刻的点。

第二种情况，我们只希望机器人沿着某个轨迹$(x_i, y_i)$运动并不偏离该轨迹太远，而不要求某个时刻要运动到某个位置。

### collision avoidance

## 通用优化算法

## 基于马尔可夫过程结构的优化算法

### DDP

### LQR



