## 11_移动机器人优化问题特点

机器人运动规划问题相比于更一般的规划问题有以下两个特点：

1. 机器人运动规划一般采用离散的形式，将轨迹表示成一个个状态点，并用马尔可夫过程来建模，即下一状态只与当前状态下的行动有关而与更早的状态无关，从而我们其实可以得到一组等式约束：
```math
s_t = d(s_{t-1}, a_{t-1}), \forall i \in [1, t] 
```
其中d为运动学方程。
从而在设计代价函数的过程中，也可以对轨迹上各个状态独立设计：
```math
c_t = c(s_{t}, a_{t})
```
2. 机器人运动规划中常用的优化算法一般希望代价函数的一阶导数是连续的。


## 基于马尔可夫过程结构的优化算法

如果我们用优化的方法求解运动规划问题，实际上是在以下空间上优化代价函数：

$$
(x_0, u_0, x_1, u_1, \dots, x_n, u_n)
$$

其中 $x_0$ 为初始状态， $u_n$ 为轨迹最终状态的控制，可以省略；但为方便起见我们暂且列出。

如第二章中所讲，运动规划问题的任务是生成一条符合运动学模型的轨迹：

$$
x_{t+1} = f(x_t, u_t)
$$

从而我们有了许多个限制条件。而这些限制条件符合马尔可夫过程的特点：未来的状态只与当前状态和控制有关，与过去的状态无关。我们可以针对这一特点设计一些优化算法。

### LQR

我们假定代价函数为二次型，运动学模型为线性的，即：

```math
x_{k+1} = Ax_k + Bu_k \\
c(x_k, u_k) = x_k^T Q x_k + u_k^T R u^k
```

其中 $Q \succ 0, R \succ 0$ 。

考虑 $t$ 时刻的cost-to-go函数的最小值：

$$
J_t(x) = \min_u x_k^T Q x_k + u_k^T R u^k + J_{t+1} (Ax + Bu)
$$

而对于最末状态，我们可以取其代价函数(可令 $P_0 = Q$ )：

$$
J_T(x) = x^T P_0 x
$$

从而

$$
J_{T-1}(x) = \min_u x_k^T Q x_k + u_k^T R u^k + (Ax + Bu)^T Q (Ax + Bu)
$$

这是对于 $u$ 的二次型，可知

$$
u = -(R + B^T P_0 B)^{-1} B^T P_0 A x
$$

代回得：

$$
J_{T-1}(x) = x^T P_1 x
$$

其中

$$
P_1 = Q + K_1^T R K_1 + (A + B K_1)^T  P_0 (A + B K_1) 
$$

$$
K_1 = -(R + B^T P_0 B)^{-1} B^T P_0 A
$$

这又是一个二次型，从而可以一直迭代到$t=0$，我们可以从给定的初始状态 $x_0$ 得到 $u_0$ ，进而得知每一个时刻的最佳控制 $u_t$ 。


### iLQR

iterative LQR是用于解决非线性动力学模型、非二次型代价函数的，比较一般的运动规划问题的好方法。

我们对于一条初始轨迹：

$$
(x_0*, u_0*, x_1*, u_1*, \dots, x_T*, u_T*)
$$

取其运动学方程的泰勒展开进行一阶近似得到线性的运动学方程：

$$
x_{t+1} \approx f(x_t*, u_t*) + \frac {\partial f(x_t*, u_t*) } {\partial x} (x_t - x_t*) + \frac {\partial f(x_t*, u_t*) } {\partial u} (u_t - u_t*) 
$$

$$
x_{t+1} - x_{t+1}* \approx A_t (x - x_t*) + B_t (u - u_t*)
$$

从而我们将问题近似化为了以 $(x-x*, u-u*)$ 为中心的，线性时变的LQR问题。

我们可以用LQR的方法求解此问题，得到初始轨迹附近的最优轨迹，然后重复此过程直到收敛。

Reference: [Pieter's slides](https://people.eecs.berkeley.edu/~pabbeel/cs287-fa12/slides/LQR.pdf)
