# 运动规划基础知识

本章节介绍一些运动规划算法中常遇到的数学和算法知识，包括运动学模型和简单的碰撞检测。

## 移动机器人运动学模型

这里先列举一些基础概念：

* 控制（control）：指机器人的执行器（马达等）收到的输入，常见包括电压电流，力矩，加速度，加加速度，角加速度等。

* 状态（state）：指机器人的当前状态，比如重心位置，各关节角度，前轮转向角，速度与加速度等。

可以看到加速度有时候被认为是状态的一个元素，有时候被认为是控制的一部分，这取决于不同的动力学模型。有的运动学模型较精确，使用加加速度作为控制，这时候加速度就是状态的一部分了。

动力学模型的选择取决于机器人的构型，执行器可接受的输入等。在移动机器人中，常用以下几种动力学模型：

### 差分模型

差分模型是一种相对简单的运动学模型，它适用于带差分轮的扫地机器人或其他室内机器人。差分轮指平行，等半径的一对轮子，可以分别控制两个轮子的角速度或角加速度，从而完成前进、倒退、转向等各种操作。

<img src="resources/sweeping.jpg" width="300" height="300"/><img src="resources/balance_car.jpg" width="300" height="300"/>

在此讨论的模型假定移动机器人有其他万向轮作为从动轮，起到支撑的作用，所以只需讨论二维空间的平面移动；而常见的平衡车模型还需要采用类似于倒立摆的方式处理平衡问题，在此暂不讨论。

![differential_model](resources/differential_model.png)


其状态空间为：

* $x, y$：机器人中心点的二维坐标。注意这里的中心点一般指两个轮子连线的中心，如果要采用其他参考点表达机器人的位置的话，可能需要做些变换。
* $\phi$：机器人朝向的角度。

其控制空间为：

* $\omega_L, \omega_R$：左右轮转动的角速度。

下面推导其运动学方程:

$$ v = \frac{(\omega_L + \omega_R) r}{2} $$
$$ \dot{x} = v \cos \phi $$
$$ \dot{y} = v \sin \phi $$
$$ \dot{\phi} = \frac{(\omega_R - \omega_L) r}{b} $$

因此差分模型的运动学方程为：

$$ \begin{bmatrix} \dot{x} \\ \dot{y} \\ \dot{\phi} \end{bmatrix} = \begin{bmatrix} \frac{r \cos \phi}{2} & \frac{r \cos \phi}{2} \\ \frac{r \sin \phi}{2} & \frac{r \sin \phi}{2} \\ -\frac{r}{b} & \frac{r}{b} \end{bmatrix} \begin{bmatrix} \omega_L \\ \omega_R \end{bmatrix} $$

Reference: [Wikipedia](https://en.wikipedia.org/wiki/Differential_wheeled_robot)

### 自行车模型

自行车模型是一种最简化的前轮控制转向的车辆模型。它是适用于常见的，前轮控制转向的四轮车辆的一种简化的模型，将四轮车辆近似成前轮转向的自行车。

<img src="resources/BicycleModel.svg" width="300" height="300" style="background: white"/><img src="resources/BicycleModelGeometry.svg" width="300" height="300" style="background: white"/>

其状态空间为：

* $x, y$：机器人中心点的二维坐标。
* $\theta$：机器人朝向的角度。
* $v$：机器人的线速度。

其控制空间为：

* $a$：机器人的线加速度。
* $\delta$：前轮转向角。

通过瞬时旋转中心(instant center of rotation)作为辅助，易推导其运动学方程为：

$$ \begin{bmatrix} \dot{x} \\ \dot{y} \\ \dot{\theta} \\ \dot{v} \end{bmatrix} = \begin{bmatrix} v \cos \theta \\ v \sin \theta \\ v/L \tan \delta \\ a \end{bmatrix} $$

Reference: [KinematicsBycicleModel](https://thomasfermi.github.io/Algorithms-for-Automated-Driving/Control/BicycleModel.html#)

## 计算几何学

计算几何学是用数学的方法研究几何关系的学问， 在运动规划中常有涉及，比如碰撞检测，势能场的设计，仿真评测系统中机器人运动轨迹的评判指标等。它会用到高中数学中学到的解析几何、向量相关的知识。

### 状态和形状的表达

本章节主要研究二维平面中的问题，许多三维情况下的表示方法和算法可以用二维的处理方法类比推知。以下为几种常见的几何形状的常见数学表达方法：

| 形状       | 数学表达                                | 解释                           |
| ---------- | --------------------------------------- | ------------------------------ |
| 点         | $(x, y)$                                | 横纵坐标                       |
| 圆         | $(x, y, r)$                             | 圆心坐标和半径                 |
| 线段       | $(x_0, y_0, x_1, y_1)$                  | 两端点坐标                     |
| 任意矩形   | $(x, y, l, w, \theta)$                  | 中心点坐标，长度，宽度，旋转角 |
| 任意多边形 | $(x_0, y_0, x_1, y_1, \dots, x_n, y_n)$ | 按逆时针顺序存放的顶点坐标     |

三维情况同理，我们用一串数字表达空间中的各种形状。要注意的是，三维中的复杂形状通常采用三角形面片的方式来表达。

### 碰撞检测

#### 简单的碰撞检测

下面将相对简单的碰撞检测的解法列举如下：

| 形状     | （一种可能的）碰撞检测方法                                                                    |
| -------- | --------------------------------------------------------------------------------------------- |
| 点与圆   | 计算点与圆心距离，并与半径比较                                                                |
| 圆与圆   | 计算圆心间距，并与半径的和或差比较                                                            |
| 点与矩形 | 使用齐次变换将点变换到以矩形中心为原点，长轴方向为$x$轴的坐标系中，再将坐标与矩阵半长宽作比较 |

#### 线段与线段

对于线段$(x_0, y_0, x_1, y_1)$ 与 $(x'_0, y'_0, x'_1, y'_1)$而言，我们可以找到他们的参数方程：

$$
\begin{cases}
x = x_0 + (x_1 - x_0)t \\
y = y_0 + (y_1 - y_0)t
\end{cases}
$$

和

$$
\begin{cases}
x = x_0' + (x_1' - x_0')t' \\
y = y_0' + (y_1' - y_0')t'
\end{cases}
$$

联立求解可得$t, t'$的值（或无解/无穷多解，意味着两线段平行或两线段在同一直线上），判断其是否在$0.0-1.0$之间，可确定两线段所在直线交点是否在两线段内，从而判断其相交情况。

#### 点与任意多边形

一般来说，假设这里的多边形为简单多边形，即顶点坐标所围形状没有重合的部分。更进一步可以要求多边形为凸多边形。凸多边形有很多较好的性质，可以让计算更加方便，工程上在条件允许的情况下，也常使用多边形的凸包作为近似。

我们可以从这一点向任意方向做一条射线（通常可选$x$轴），然后使用前述方法计算这条射线和多边形各边的交点总数，如果点在多边形内，这条射线和多边形的边的交点总数应为奇数，反之则应为偶数。当然也要注意讨论点在多边形边上，或者射线恰好与一条边重合等情况。

Reference: [Wikipedia](https://en.wikipedia.org/wiki/Point_in_polygon#:~:text=One%20simple%20way%20of%20finding,an%20even%20number%20of%20times.)

#### 矩形与矩形

矩形是工程中很常用的形状，也具有很好的性质，所以对于矩形和矩形的碰撞检测也有单独的讨论。这里我们重点介绍一般的情况，即任意矩形（又称OBB, oriented bounding box）间的碰撞检测。

下面介绍分割轴定理（Separating axis theorem）：两个形状有重合的部分，当且仅当其在所有法线（法平面）上的投影都有重合。

我们先取一个矩形某条边的中垂线，并计算两个矩形在这条线上的投影：

<img src="resources/obb_1.jpg" width="300"/>

再取另一条中垂线并计算投影：

<img src="resources/obb_2.jpg" width="300"/>

这里我们发现两个投影并没有重合部分，说明两个矩形并不相交。

注意，这个算法也可用于检测凸多边形之间的相交关系，并且也容易推广到三维的情况。

#### 工程中的加速方法

许多工程中的碰撞检测都是计算的瓶颈，因此提高碰撞检测的计算效率是一项比较常见的任务。

通常可以考虑以下算法提高碰撞检测计算的速度：

* Bounding Volume Hierarchy. 通过用树状结构表示空间中的物体，用粗略的检测快速筛选出需要精细计算的部分，可以节省计算资源并提高速度。Reference: [Wikipedia](https://en.wikipedia.org/wiki/Bounding_volume_hierarchy)
* 用平方计算代替开方计算，例如在需要判断距离时，我们可以判断距离的平方的大小关系。计算机在执行不同运算时的速度有所不同，一般认为乘法远快于开方。Reference: [ithare](http://ithare.com/infographics-operation-costs-in-cpu-clock-cycles/)

因为经常需要计算多个物体之间的碰撞关系，或者对于多边形，需要遍历所有边进行计算，对于成熟的运用场景，可以考虑使用并行计算的方法加快速度：

* SIMD or Auto Vectorization: 现代CPU、现代高级编程语言在合理的优化等级下，会自动使用AVX或类似的指令集加速可以并行的计算。如果自动矢量化效果不理想，也可以自己手写SIMD等CPU并行代码进行加速。
* Multi-threading：某些情况下多线程可以算得更快。
* GPU: 对于规模更大、更复杂的场景，特别是三维空间的碰撞检测，可以考虑使用GPU进行计算。

当然，一切计算的效率以实测为准。笔者就曾遇到过信誓旦旦写了BVH算法以为会更快，结果被Auto Vectorization吊打的尴尬情况。