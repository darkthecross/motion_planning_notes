# 运动规划基础知识

本章节介绍一些运动规划算法中常遇到的数学和算法知识，包括运动学模型和简单的碰撞检测。

- [运动规划基础知识](#运动规划基础知识)
  - [什么是规划](#什么是规划)
  - [规划可以解决的问题](#规划可以解决的问题)
    - [益智拼图](#益智拼图)
    - [大货车倒库](#大货车倒库)
    - [无人机穿越复杂地形](#无人机穿越复杂地形)
    - [设计NPC](#设计npc)
  - [规划的要素](#规划的要素)
    - [状态](#状态)
    - [时间](#时间)
  - [状态的表达](#状态的表达)
  - [移动机器人运动学模型](#移动机器人运动学模型)
    - [差分模型](#差分模型)
    - [自行车模型](#自行车模型)
  - [计算几何学](#计算几何学)
    - [状态和形状的表达](#状态和形状的表达)


## 什么是规划

// TODO(fanmx): 从钢琴、魔方和华容道说起

规划一词对于不同的人、在不同的领域有不同的意义。在机器人学中，一个基本的需求是设计一套算法，将高阶、抽象的任务转换成底层的机械控制。例如我们想要用一台六轴工业机器人将一个零件从一个位置移动到另一个位置，那么每个时刻机器人的每一个关节该如何转动；或者一辆自动驾驶汽车将乘客从A点运送到B点，该选择怎样的路线、又该进行怎样的油门和方向盘控制等。在介绍相对而言更复杂的问题之前，让我们先来看一个相对简单的问题，来帮助我们理解机器人运动规划中的几大要素：挪钢琴。

挪钢琴问题顾名思义，是一个在房间里移动钢琴的问题：假设我们有一架钢琴的三维模型和整个房子的三维模型，我们希望寻找一条*轨迹*，将钢琴从一个位置，经过走廊、楼梯、或许相对狭窄的门，搬到另一个指定房间的指定位置。钢琴的中心位置和旋转角度给它带来了六个自由度，所以这个规划问题是在这样一个六维空间中；而具体地，我们可以选择离散地用许多个点来表达这条轨迹，或者连续地用一个函数来表达，寻找这样一条轨迹的任务就是一个很典型的规划问题。

<img src="resources_2/piano_mover.png" width="600"/>

Image credit: [Research Gate](https://www.researchgate.net/figure/The-piano-movers-problem-EET_fig45_273396838)

## 规划可以解决的问题

运动规划可以用来解决十分广泛的问题：

### 益智拼图

例如鲁班锁，或者Alpha Puzzle：

<img src="resources_2/lubansuo.jpg" width="300" height="200"/><img src="resources_2/puzzle.png" width="300" height="200"/>

我们可以用CAD三维建模来表达每个部分的几何形状，将各个部件纠缠在一起的状态视为初始状态，再设计一个各个部件分开的状态作为目标状态。如果我们能够通过运动规划的方法寻找一个从初始状态到目标状态的、没有碰撞（三维世界不许穿模！）的轨迹便可以解决对应的益智拼图。

### 大货车倒库

大货车倒车入库是一个比一般人设想更复杂的问题，因为货车车厢没有主动动力，其朝向的改变完全由车头控制。倒车入库时，需要先调整车头使得车厢的后轮对准车位；然后反向转动方向盘，使得车头的后轮也对准车位；最后车头回正倒车，完成整个入库的过程。

<img src="resources_2/truck_reverse.jpg" width="300" height="200"/>

Reference: [Wikihow](https://www.wikihow.com/Park-a-Truck-or-Large-Vehicle)

### 无人机穿越复杂地形

无人机具有相对复杂的动力学模型，通过控制它的各个马达，不仅可以保持近似直立的状态从一个位置到另一个位置，更可以做出倾斜、滑翔等复杂的特技动作。对于高架桥下、树丛中的复杂情况，如果有精密的感知和先进的运动规划算法支持，无人机可以更安全地通过狭窄而复杂的地形，减小炸机的可能性。

### 设计NPC

现代游戏中的NPC，不论是AI还是Boss，逐渐都变得更加复杂，需要在不断变化的情境中做出一些决策。规划算法便可以用于帮助NPC完成一些任务，以增强其智能性。运动规划算法可以帮助NPC选择最短的路径以达到目标，例如魔兽世界中的怪物要追着攻击距离最近的敌人，它便需要理解如何缩短与目标之间的距离；战棋类游戏中的规划算法更是可以决定整体的布局策略，给玩家带来更有挑战性的体验。

## 规划的要素

各种各样的规划问题都有一些通用的要素：

### 状态

所有的规划问题都需要在*状态空间*上进行。

所谓状态空间，指的是在一个规划问题中，所有可能达到的状态或情形。在挪钢琴问题中，它是所有可能的钢琴中心坐标和旋转角度；在直升机运动规划中，它可以是直升机当前在三维空间中的位置、角度和速度；在华容道游戏中，它可以是所有可能的棋子排布的方式；在围棋中，它是所有合法的棋盘状态。视规划问题不同、规划算法不同，状态空间既可以是连续的，也可以是离散的。当然要注意的是，在实际的规划算法当中，由于状态空间内包含的状态数目巨大（甚至可以是无穷大），我们往往难以表达所有状态空间中的状态，从而常常主要关注有限多的、有一定特点的状态。

### 时间

所有的规划问题都涉及到一连串的、需要按照时间顺序来执行的决策或行动。



## 状态的表达

如果希望通过数学或者计算机的方法解决运动规划的问题，首先我们应该建立一个数学模型来表示机器人的状态。我们这里以倒立摆为例：

// TODO(fanmx): 加个倒立摆




## 移动机器人运动学模型

这里先列举一些基础概念：

* 控制（control）：指机器人的执行器（马达等）收到的输入，常见包括电压电流，力矩，加速度，加加速度，角加速度等。

* 状态（state）：指机器人的当前状态，比如重心位置，各关节角度，前轮转向角，速度与加速度等。

可以看到加速度有时候被认为是状态的一个元素，有时候被认为是控制的一部分，这取决于不同的动力学模型。有的运动学模型较精确，使用加加速度作为控制，这时候加速度就是状态的一部分了。

TODO(fanmx): 简单介绍运动学方程的使用方法，考虑介绍欧拉积分和RK积分。

动力学模型的选择取决于机器人的构型，执行器可接受的输入等。在移动机器人中，常用以下几种动力学模型：

### 差分模型

差分模型是一种相对简单的运动学模型，它适用于带差分轮的扫地机器人或其他室内机器人。差分轮指平行，等半径的一对轮子，可以分别控制两个轮子的角速度或角加速度，从而完成前进、倒退、转向等各种操作。

<img src="resources/sweeping.jpg" width="300" height="300"/><img src="resources/balance_car.jpg" width="300" height="300"/>

在此讨论的模型假定移动机器人有其他万向轮作为从动轮，起到支撑的作用，所以只需讨论二维空间的平面移动；而常见的平衡车模型还需要采用类似于倒立摆的方式处理平衡问题，在此暂不讨论。

![differential_model](resources/differential_model.png)


其状态空间为：

* $x, y$：机器人中心点的二维坐标。注意这里的中心点一般指两个轮子连线的中心，如果要采用其他参考点表达机器人的位置的话，可能需要做些变换。
* $\phi$：机器人朝向的角度。

其控制空间为：

* $\omega_L, \omega_R$：左右轮转动的角速度。

下面推导其运动学方程:

$$v = \frac{(\omega_L + \omega_R) r}{2}$$

$$\dot{x} = v \cos \phi$$

$$\dot{y} = v \sin \phi$$

$$\dot{\phi} = \frac{(\omega_R - \omega_L) r}{b}$$

因此差分模型的运动学方程为：

```math
\begin{bmatrix}\dot{x}\\ \dot{y}\\ \dot{\phi}\end{bmatrix}=\begin{bmatrix}\frac{r \cos \phi}{2}&\frac{r \cos \phi}{2}\\ \frac{r \sin \phi}{2}&\frac{r \sin \phi}{2}\\ -\frac{r}{b}&\frac{r}{b}\end{bmatrix}\begin{bmatrix}\omega_L\\ \omega_R\end{bmatrix}
```

Reference: [Wikipedia](https://en.wikipedia.org/wiki/Differential_wheeled_robot)

### 自行车模型

自行车模型是一种最简化的前轮控制转向的车辆模型。它是适用于常见的，前轮控制转向的四轮车辆的一种简化的模型，将四轮车辆近似成前轮转向的自行车。

<img src="resources/bicycle_1.png" width="300" height="300"/><img src="resources/icr.png" width="300" height="300"/>

其状态空间为：

* $x, y$：机器人中心点的二维坐标。
* $\theta$：机器人朝向的角度。
* $v$：机器人的线速度。

其控制空间为：

* $a$：机器人的线加速度。
* $\delta$：前轮转向角。

通过瞬时旋转中心(instant center of rotation)作为辅助，易推导其运动学方程为：

```math
\begin{bmatrix} \dot{x} \\ \dot{y} \\ \dot{\theta} \\ \dot{v} \end{bmatrix} = \begin{bmatrix} v \cos \theta \\ v \sin \theta \\ v/L \tan \delta \\ a \end{bmatrix}
```

Reference: [KinematicsBycicleModel](https://thomasfermi.github.io/Algorithms-for-Automated-Driving/Control/BicycleModel.html#)

## 计算几何学

计算几何学是用数学的方法研究几何关系的学问， 在运动规划中常有涉及，比如碰撞检测，势能场的设计，仿真评测系统中机器人运动轨迹的评判指标等。它会用到高中数学中学到的解析几何、向量相关的知识。

### 状态和形状的表达

本章节主要研究二维平面中的问题，许多三维情况下的表示方法和算法可以用二维的处理方法类比推知。以下为几种常见的几何形状的常见数学表达方法：

| 形状       | 数学表达                                | 解释                           |
| ---------- | --------------------------------------- | ------------------------------ |
| 点         | $(x, y)$                                | 横纵坐标                       |
| 圆         | $(x, y, r)$                             | 圆心坐标和半径                 |
| 线段       | $(x_0, y_0, x_1, y_1)$                  | 两端点坐标                     |
| 任意矩形   | $(x, y, l, w, \theta)$                  | 中心点坐标，长度，宽度，旋转角 |
| 任意多边形 | $(x_0, y_0, x_1, y_1, \dots, x_n, y_n)$ | 按逆时针顺序存放的顶点坐标     |

三维情况同理，我们用一串数字表达空间中的各种形状。要注意的是，三维中的复杂形状通常采用三角形面片的方式来表达。

